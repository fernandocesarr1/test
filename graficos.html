<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <title>Gr√°ficos - COF</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/styles.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <a href="dashboard.html" class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                COF
            </a>
            
            <button class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
            
            <nav class="nav" id="mainNav">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="adicionar.html" class="nav-link">Adicionar</a>
                <a href="graficos.html" class="nav-link active">Gr√°ficos</a>
                <a href="historico.html" class="nav-link">Hist√≥rico</a>
                <a href="pesquisa.html" class="nav-link">Pesquisa</a>
                <a href="config.html" class="nav-link">Config</a>
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Alternar tema">üåô</button>
                <button class="btn btn-ghost btn-sm" onclick="logout()">Sair</button>
            </nav>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container" style="padding: var(--space-xl) var(--space-md);">
        <h1 style="margin-bottom: var(--space-lg);">üìä An√°lise Gr√°fica</h1>
        
        <!-- Filters -->
        <div class="card fade-in" style="margin-bottom: var(--space-lg);">
            <div class="flex gap-md items-center" style="flex-wrap: wrap;">
                <div class="form-group" style="margin: 0; min-width: 150px;">
                    <label class="form-label">Ano</label>
                    <select class="form-select" id="filterYear"></select>
                </div>
                <div class="form-group" style="margin: 0; min-width: 200px;">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="filterCategory">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0; min-width: 150px;">
                    <label class="form-label">Respons√°vel</label>
                    <select class="form-select" id="filterResponsavel">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Charts Grid -->
        <div class="grid grid-2">
            <!-- Monthly Evolution -->
            <div class="card fade-in">
                <h3 class="card-title">Evolu√ß√£o Mensal</h3>
                <div style="height: 300px;">
                    <canvas id="chartMonthly"></canvas>
                </div>
            </div>
            
            <!-- Category Distribution -->
            <div class="card fade-in">
                <h3 class="card-title">Distribui√ß√£o por Categoria</h3>
                <div style="height: 300px;">
                    <canvas id="chartCategory"></canvas>
                </div>
            </div>
            
            <!-- Fixed vs Variable -->
            <div class="card fade-in">
                <h3 class="card-title">Fixos vs Vari√°veis</h3>
                <div style="height: 300px;">
                    <canvas id="chartTipo"></canvas>
                </div>
            </div>
            
            <!-- By Responsavel -->
            <div class="card fade-in">
                <h3 class="card-title">Por Respons√°vel</h3>
                <div style="height: 300px;">
                    <canvas id="chartResponsavel"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Comparison Table -->
        <div class="card fade-in" style="margin-top: var(--space-lg);">
            <h3 class="card-title">Comparativo Mensal</h3>
            <div class="table-container" style="margin-top: var(--space-md);">
                <table class="table" id="comparisonTable">
                    <thead>
                        <tr>
                            <th>M√™s</th>
                            <th>Fixos</th>
                            <th>Vari√°veis</th>
                            <th>Total</th>
                            <th>Varia√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonBody"></tbody>
                </table>
            </div>
        </div>
    </main>
    
    <div id="toast-container"></div>
    
    <script src="js/shared.js"></script>
    <script>
        if (!checkAuth()) window.location.href = 'index.html';
        initFirebase();
        
        let gastos = [];
        let appData = {};
        let charts = {};
        let selectedYear = new Date().getFullYear();
        
        const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const colors = ['#3b82f6', '#8b5cf6', '#f59e0b', '#22c55e', '#ef4444', '#06b6d4', '#ec4899', '#84cc16'];
        
        function initFilters() {
            const yearSelect = document.getElementById('filterYear');
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 3; y <= currentYear; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === selectedYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            
            yearSelect.addEventListener('change', () => {
                selectedYear = parseInt(yearSelect.value);
                updateCharts();
            });
            
            document.getElementById('filterCategory').addEventListener('change', updateCharts);
            document.getElementById('filterResponsavel').addEventListener('change', updateCharts);
        }
        
        function loadData() {
            database.ref('appData').once('value', (snapshot) => {
                appData = snapshot.val() || {};
                
                // Populate category filter
                const catSelect = document.getElementById('filterCategory');
                const allCats = [...(appData.categorias?.fixas || []), ...(appData.categorias?.variaveis || [])];
                allCats.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    catSelect.appendChild(opt);
                });
                
                // Populate responsavel filter
                const respSelect = document.getElementById('filterResponsavel');
                (appData.nomes || []).forEach(nome => {
                    const opt = document.createElement('option');
                    opt.value = nome;
                    opt.textContent = nome;
                    respSelect.appendChild(opt);
                });
            });
            
            database.ref('gastos').on('value', (snapshot) => {
                gastos = snapshot.val() ? Object.values(snapshot.val()) : [];
                updateCharts();
            });
        }
        
        function getFilteredData() {
            const category = document.getElementById('filterCategory').value;
            const responsavel = document.getElementById('filterResponsavel').value;
            
            return gastos.filter(g => {
                if (!g.data) return false;
                const year = parseInt(g.data.split('-')[0]);
                if (year !== selectedYear) return false;
                if (category && g.categoria !== category) return false;
                if (responsavel && g.responsavel !== responsavel) return false;
                return true;
            });
        }
        
        function updateCharts() {
            const filtered = getFilteredData();
            updateMonthlyChart(filtered);
            updateCategoryChart(filtered);
            updateTipoChart(filtered);
            updateResponsavelChart(filtered);
            updateComparisonTable(filtered);
        }
        
        function updateMonthlyChart(data) {
            const ctx = document.getElementById('chartMonthly').getContext('2d');
            
            const monthlyData = Array(12).fill(0);
            data.forEach(g => {
                const month = parseInt(g.data.split('-')[1]) - 1;
                monthlyData[month] += parseFloat(g.valor) || 0;
            });
            
            if (charts.monthly) charts.monthly.destroy();
            
            charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Total',
                        data: monthlyData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatCurrency(ctx.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => formatCurrency(v)
                            }
                        }
                    }
                }
            });
        }
        
        function updateCategoryChart(data) {
            const ctx = document.getElementById('chartCategory').getContext('2d');
            
            const byCategory = {};
            data.forEach(g => {
                const cat = g.categoria || 'Outros';
                byCategory[cat] = (byCategory[cat] || 0) + (parseFloat(g.valor) || 0);
            });
            
            if (charts.category) charts.category.destroy();
            
            const labels = Object.keys(byCategory);
            const values = Object.values(byCategory);
            
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    }
                }
            });
        }
        
        function updateTipoChart(data) {
            const ctx = document.getElementById('chartTipo').getContext('2d');
            
            const fixos = Array(12).fill(0);
            const variaveis = Array(12).fill(0);
            
            data.forEach(g => {
                const month = parseInt(g.data.split('-')[1]) - 1;
                const valor = parseFloat(g.valor) || 0;
                if (g.tipo === 'fixo') fixos[month] += valor;
                else variaveis[month] += valor;
            });
            
            if (charts.tipo) charts.tipo.destroy();
            
            charts.tipo = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Fixos',
                            data: fixos,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Vari√°veis',
                            data: variaveis,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (v) => formatCurrency(v) }
                        }
                    }
                }
            });
        }
        
        function updateResponsavelChart(data) {
            const ctx = document.getElementById('chartResponsavel').getContext('2d');
            
            const byResp = {};
            data.forEach(g => {
                const resp = g.responsavel || 'N√£o informado';
                byResp[resp] = (byResp[resp] || 0) + (parseFloat(g.valor) || 0);
            });
            
            if (charts.responsavel) charts.responsavel.destroy();
            
            charts.responsavel = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(byResp),
                    datasets: [{
                        data: Object.values(byResp),
                        backgroundColor: ['#3b82f6', '#ec4899', '#22c55e', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    }
                }
            });
        }
        
        function updateComparisonTable(data) {
            const tbody = document.getElementById('comparisonBody');
            
            const monthlyData = [];
            for (let m = 0; m < 12; m++) {
                const monthData = data.filter(g => {
                    const month = parseInt(g.data.split('-')[1]) - 1;
                    return month === m;
                });
                
                const fixos = monthData.filter(g => g.tipo === 'fixo').reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                const variaveis = monthData.filter(g => g.tipo === 'variavel').reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                const total = fixos + variaveis;
                
                monthlyData.push({ month: m, fixos, variaveis, total });
            }
            
            let html = '';
            monthlyData.forEach((row, i) => {
                const prev = i > 0 ? monthlyData[i - 1].total : 0;
                let variation = '';
                if (prev > 0 && row.total > 0) {
                    const diff = ((row.total - prev) / prev * 100).toFixed(1);
                    const cls = diff > 0 ? 'text-error' : 'text-success';
                    variation = `<span class="${cls}">${diff > 0 ? '+' : ''}${diff}%</span>`;
                }
                
                html += `
                    <tr>
                        <td>${months[row.month]}</td>
                        <td>${formatCurrency(row.fixos)}</td>
                        <td>${formatCurrency(row.variaveis)}</td>
                        <td><strong>${formatCurrency(row.total)}</strong></td>
                        <td>${variation || '-'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function toggleNav() {
            document.getElementById('mainNav').classList.toggle('open');
        }
        
        initFilters();
        loadData();
    </script>
</body>
</html>
