<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Controle Or칞ament치rio Familiar - Gerencie suas finan칞as">
    <meta name="theme-color" content="#3b82f6">
    <title>Login - COF</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="login-container">
        <!-- Background Blobs -->
        <div class="login-bg-blob purple float-animation"></div>
        <div class="login-bg-blob blue float-animation"></div>
        
        <!-- Login Card -->
        <div class="login-card fade-in">
            <div class="login-header">
                <div class="login-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <h1 class="login-title">Bem-vindo!</h1>
                <p class="login-subtitle">Controle Or칞ament치rio Familiar</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="nome">Quem est치 acessando?</label>
                    <select class="form-select" id="nome" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="senha">Senha</label>
                    <input type="password" class="form-input" id="senha" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;" id="btnLogin">
                    <span id="btnText">Entrar</span>
                    <span id="btnLoading" class="hidden">Verificando...</span>
                </button>
                
                <div class="mt-md text-center">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="toggleDarkMode()">
                        游깿 Alternar Tema
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="js/shared.js"></script>
    <script>
        // Verificar se j치 est치 logado
        if (sessionStorage.getItem('authenticated') === 'true') {
            window.location.href = 'dashboard.html';
        }
        
        // Inicializar Firebase
        initFirebase();
        
        // Carregar usu치rios
        function loadUsers() {
            database.ref('appData/nomes').once('value', (snapshot) => {
                const nomes = snapshot.val() || ['Fernando', 'Estefania'];
                const select = document.getElementById('nome');
                
                nomes.forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = nome;
                    select.appendChild(option);
                });
            });
        }
        
        // Verificar senha
        function verifyPassword(inputSenha) {
            return new Promise((resolve) => {
                database.ref('appData/senha').once('value', (snapshot) => {
                    const senhaSalva = snapshot.val() || '1234';
                    resolve(inputSenha === senhaSalva);
                });
            });
        }
        
        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const senha = document.getElementById('senha').value;
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            const btnLogin = document.getElementById('btnLogin');
            
            if (!nome) {
                showToast('Selecione quem est치 acessando', 'warning');
                return;
            }
            
            // Loading state
            btnLogin.disabled = true;
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');
            
            try {
                const senhaCorreta = await verifyPassword(senha);
                
                if (senhaCorreta) {
                    sessionStorage.setItem('authenticated', 'true');
                    sessionStorage.setItem('userName', nome);
                    showToast(`Ol치, ${nome}! 游녦`, 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);
                } else {
                    showToast('Senha incorreta!', 'error');
                    btnLogin.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            } catch (error) {
                showToast('Erro ao verificar. Tente novamente.', 'error');
                btnLogin.disabled = false;
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        });
        
        // Init
        loadUsers();
        
        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
</body>
</html>
